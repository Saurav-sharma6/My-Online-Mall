{% extends 'shop/basic.html' %}

{% block title %}Checkout{% endblock %}

{% block body %}
  <div class="container">
    <div class="col my-4">
      <h2>My-Online-Mall Checkout - Review your cart items</h2>
      <div class="col my-4">
        <ul class="list-group" id='items'>

          <!-- Items are appended here by using javascript . See javascript below in this file -->

        </ul>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item active" aria-current="page">
              <h5 class="col my-2">
                Total bill : Rs. <span id='total'><!-- Total price is appended here by using javascript --></span> only
              </h5>
            </li>
          </ol>
        </nav>
      </div>
    </div>
    <div class="col my-4">
      <h2>Fill your details</h2>
      <form method = "POST" action = '/shop/checkout/'>
        {% csrf_token %}

        <!-- Value of this hidden item is set using javascript below -->
        <input type="hidden" name="itemsJson" id="itemsJson">
        <input type="hidden" name="amount" id="amount">

        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="inputname">Name</label>
            <input type="text" class="form-control" name="name" id="name" placeholder="Name" required>
          </div>
          <div class="form-group col-md-6">
            <label for="inputEmail4">Email</label>
            <input type="email" class="form-control" name="email" id="email" placeholder="Email">
          </div>
        </div>
        <div class="form-group">
          <label for="inputAddress">Address</label>
          <input type="text" class="form-control" id="address1" name="address1" placeholder="1234 Main St" required>
        </div>
        <div class="form-group">
          <label for="inputAddress2">Address 2</label>
          <input type="text" class="form-control" id="address2" name="address2" placeholder="Apartment, studio, or floor">
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="inputCity">City</label>
            <input type="text" class="form-control" id="city" name="city" required>
          </div>
          <div class="form-group col-md-4">
            <label for="inputState">State</label>
            <input type="text" class="form-control" id="state" name="state" required>
          </div>
          <div class="form-group col-md-2">
            <label for="inputZip">Zip</label>
            <input type="text" class="form-control" id="zip_code" name="zip_code" required>
          </div>
        </div>
        <div class="form-group">
          <label for="inputPhone">Phone Number</label>
          <input type="text" class="form-control" id="phone" name="phone" required>
        </div>
        <button type="submit" class="btn btn-primary">Place Order</button>
      </form>
    </div>
  </div>
{% endblock %}


{% block js %}
<script>

  // Find out cart item from local storage
  if(localStorage.getItem('cart') == null){
    var cart = {};
  }
  else{
    cart = JSON.parse(localStorage.getItem('cart'));
  }
  var sum = 0;
  var total_bill = 0;
  if ($.isEmptyObject(cart)){
    // Using some ES-6 features
    // `` is used by pressing button between tab and esc.
    mystr = `<h2>Your cart is empty. Please add some items to your cart before checking out!</h2>`
    $('#items').append(mystr);  // we can also use vanilla js i.e using getElementById.innerHTML
  }else{
    for(item in cart){
      let name = cart[item][1];
      let qty = cart[item][0];
      let price = cart[item][2];
      sum = sum + qty;
      total_bill = total_bill + (price * qty);
      // Using some ES-6 features
      // `` is used by pressing button between tab and esc.
      // we can use ${} as we use string f-string in python
      mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${name}
                <span class="badge badge-primary badge-pill">${qty}</span>
               </li>`
      $('#items').append(mystr);  // we can also use vanilla js i.e using getElementById.innerHTML
    }

  }
  document.getElementById('idcart').innerHTML = sum;
  document.getElementById('total').innerHTML = total_bill;

  // Setting the value of hidden input tag
  $('#itemsJson').val(JSON.stringify(cart));  // sets the value to JSON.stringify(cart)

  {% if thank %}
    alert("Your order has been successfully placed. Your order id is {{ id }}");
    localStorage.clear(); // Bcz if customer buys the item then it should be removed from cart
    document.location ='/shop'; // it will redirect to shop page once customer buys the product
  {% endif %}

  // Sets the hidden field value (having id amount) to the total_bill i.e $('#total').html()
  $('#amount').val($('#total').html())
 </script>
{% endblock %}
